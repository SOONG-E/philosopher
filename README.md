### 프로젝트 개요

2개의 포크를 사용하여 스파게티를 먹는 n명의 철학자가 n개의 포크를 이용하여 식사를 하고, 생각을 하고 잠을 자는 것을 타임스탬프와 함께 기록한다.

```
./philo <철학자 수> <안먹고 버틸 수 있는 시간> <밥 먹는 시간> <생각하는 시간> <optional: 최소 먹어야하는 횟수>
```

### 프로젝트 시작 전

mandatory파트에서는 **뮤텍스**를 이용하여 **멀티 스레드** 환경에서, bonus파트에서는 **세마포어**를 이용하여 **멀티 프로세스** 환경에서 진행해야한다.

- 멀티 스레드 환경에서 주의할 점
	- 같은 프로세스 내에 있어 메모리를 공유하고있다.
	- 같은 자원에 두 개 이상의 스레드가 접근 할 시 데이터 레이스를 방지해줘야한다.

- 멀티 프로세스 환경에서 주의할 점
	- 프로세스 간 통신을 위해선 파이프나 소켓, 시그널 등을 이용해야하지만 허용 함수에는 signal()함수만 존재한다.
	- getpid()를 사용할 수 없으므로 자식이 부모에게 시그널을 보내는 것은 불가하다.

- 공통적으로 주의할 점
	- 교착 상태가 발생하면 안된다.
	- 데이터 레이스가 발생하면 안된다.
	- 한 명이라도 죽은 후엔 아무것도 출력되어선 안된다.
	- 최소 먹어야하는 횟수를 모든 철학자가 충족할 시엔 프로그램이 종료되어야한다.
	- 출력이 꼬이면 안된다.
	- 지연을 최소화해야한다.

### 프로젝트 진행

- 프로젝트 구조
```
./
├── philo/
│   ├── Makefile
│   ├── actions.c
│   ├── actions_utils.c
│   ├── initialize.c
│   ├── manage_resource.c
│   ├── manage_time.c
│   ├── philo.c
│   ├── philo.h
│   └── utils/
│       └── ft_atoi.c
│
└── philo_bonus/
    ├── Makefile
    ├── actions.c
    ├── actions_utils.c
    ├── initialize.c
    ├── manage_processes.c
    ├── manage_resource.c
    ├── manage_time.c
    ├── philo_bonus.c
    ├── philo_bonus.h
    ├── philo_routine.c
    └── utils/
        ├── ft_atoi.c
        └── ft_itoa.c
```


- 공통 부분
	- 교착 상태의 네 가지 조건을 모두 충족해 교착 상태가 발생한다.
		- 짝수, 홀수 별로 첫 루틴을 시작하는 시간을 다르게 해 Circular Wait 조건에 반하게 한다.
	- usleep()함수가 오버헤드로 인해 정확하게 작동하지 않는다.
		- usleep()을 사용하되, 시간을 잘게 나눠 함수를 여러번 호출하며 원하는 시간이 됐는 지 계속 체크한다.
	- 철학자가 죽은 뒤에도 다른 출력문이 출력된다.
		- 출력문을 출력하는 부분도 critical 부분으로 고려하여 뮤텍스, 세마포어로 보호해준다.


- mandatory 파트
	- 포크 뮤텍스가 언락되길 기다리다 죽어버리는 경우가 생긴다.
		- 메인 스레드에서 따로 철학자가 죽었는지 체크한다.
		- 데이터 레이스가 발생하지 않게 주의한다.
	- 각 스레드가 작동 중일 때 pthread_detach()를 사용하여 자원을 회수하면 뮤텍스만 남아 쓰레기 값을 출력한다.
		- pthread_join()을 사용하여 자원을 회수하고 각 스레드는 프로그램이 종료되어야 할 때 return값을 반환해 스레드를 종료시킨다.

- bonus 파트
	- critical 자원에 접근하기 위해 블락되어 있던 중 죽어버리는 경우가 발생한다.
		- 프로세스 당 죽었는지 체크할 스레드를 하나씩 생성하여 체크한다.
		- 데이터 레이스가 발생하지 않게 주의한다.
	- 세마포어를 오픈하여 연결할 때 이미 같은 이름의 파일이 존재하는 경우가 있다.
		- 오픈하기 전 언링크해준다.
	- 프로세스에서 데이터 스레드를 방지하기 위해 사용하는 세마포어가 프로세스 수만큼 있어야 하고, 이름이 다 달라야한다.
		- ft_itoa()를 이용해 이름 뒤에 숫자를 붙인다.
	- 밥 먹는 시간이 짧은 경우, 철학자 수에 맞는 프로세스가 다 생성되기 전 생성되어있는 프로세스들이 루틴을 진행하다 종료하는 경우가 생긴다.
		- 모든 프로세스가 다 생성될 때까지 루틴을 시작하지 않고 기다리게 한다.
	- 자식 프로세스가 종료됐을 때, 죽어서 종료된 것인지 최소 횟수를 만족해서 종료된 것인지 구분해야한다.
		- 자식이 return한 exitcode를 이용해 구분한다.

### 진행 후

- 교착 상태가 발생하지 않는 지 확인한다.
- 데이터 레이스가 발생하지 않는 지 확인한다.
	- 컴파일 할 때 fsanitize=thread 옵션을 붙인다.
- 기대하던 결과대로 잘 진행하는 지 확인한다.
- 철학자 수가 짝수일 때, 홀수일 때를 둘 다 고려하여 테스트한다.
- 철학자 수가 한명일 때 바로 죽는 지 확인한다.

